//FusionCharts Gantt custom widget for SAC Version 1.0.0. Copyright 2021 Arijit Das.
(function() {
    let template = document.createElement("template");
    template.innerHTML = `<div id=chart-container-fgantt></div><style>#chart-container-fgantt{height:500px;}</style>`;
    class FGANTT extends HTMLElement {
        constructor() {
            super();
            let shadowRoot = this.attachShadow({
                mode: "open"
            });
            shadowRoot.appendChild(template.content.cloneNode(true));
            this._props = undefined;
            this._init = true;
            this._firstUpdate = true;
            this._firstResize = true;
            this._selectionEvent = false;
        }
        onCustomWidgetBeforeUpdate(changedProperties) {}
        onCustomWidgetAfterUpdate(changedProperties) {
            var shadow = this.shadowRoot;            
            let LoadLibsAfterUpdate = async function(host, data, props) {
                try {
                    await host.loadScript("https://cdn.fusioncharts.com/fusioncharts/latest/fusioncharts.js", shadow);
					await host.loadScript("https://cdn.fusioncharts.com/fusioncharts/latest/fusioncharts.gantt.js", shadow);
                    await host.loadScript("https://cdn.fusioncharts.com/fusioncharts/latest/themes/fusioncharts.theme.fusion.js", shadow);
                } catch (e) {
                    console.log(JSON.stringify(e));
                } finally {
                    host.drawChart(data, props);
                }
            };
            if (!(this._init || this._selectionEvent)) {
                if (this._firstUpdate) {
                    LoadLibsAfterUpdate(this, this.$data, this._props);
                    this._firstUpdate = false;
                } else {
                    this.drawChart(this.$data, this._props);
                }
            }
        }
        onCustomWidgetResize(width, height) {
            var shadow = this.shadowRoot;
            this.$width = width + 'px';
            this.$height = height + 'px';
            let LoadLibsAfterResize = async function(host, data, props) {
                try {
                    await host.loadScript("https://cdn.fusioncharts.com/fusioncharts/latest/fusioncharts.js", shadow);
					await host.loadScript("https://cdn.fusioncharts.com/fusioncharts/latest/fusioncharts.gantt.js", shadow);
                    await host.loadScript("https://cdn.fusioncharts.com/fusioncharts/latest/themes/fusioncharts.theme.fusion.js", shadow);
                } catch (e) {
                    console.log(JSON.stringify(e));
                } finally {
                    host.drawChart(data, props);
                }
            };
            if (this._firstResize) {
                LoadLibsAfterResize(this, this.$data, this._props);
                this._firstResize = false;
            } else {
                this.drawChart(this.$data, this._props);
            }
        }
        connectedCallback() {
            var shadow = this.shadowRoot;
            var custelem = shadow.host;
            this.$width = custelem.parentNode.parentNode.parentNode.style.width;
            this.$height = custelem.parentNode.parentNode.parentNode.style.height;
            let LoadLibs = async function(host, data, props) {
                try {
                    await host.loadScript("https://cdn.fusioncharts.com/fusioncharts/latest/fusioncharts.js", shadow);
					await host.loadScript("https://cdn.fusioncharts.com/fusioncharts/latest/fusioncharts.gantt.js", shadow);
                    await host.loadScript("https://cdn.fusioncharts.com/fusioncharts/latest/themes/fusioncharts.theme.fusion.js", shadow);
                } catch (e) {
                    console.log(JSON.stringify(e));
                } finally {
                    host.drawChart(data, props);
                }
            };
            LoadLibs(this, this.$data, this._props);
            this._init = false;
        }
        disconnectedCallback() {}
        
        drawChart(value, config) {
            const dataSource = {
			  "chart": {
				"theme": "fusion",
				"dateformat": "mm/dd/yyyy",
				"caption": "Strategic Plan",
				"captionFontSize": "14",
				"subCaption": "Project Plan : Biocon",
				"subCaptionFontSize": "12"
			  },
			  "categories": [{
				"category": [{
					"start": "01/01/2021",
					"end": "01/30/2021",
					"label": "Jan '21"
				  },
				  {
					"start": "02/01/2021",
					"end": "03/30/2021",
					"label": "Feb-Mar '21"
				  },
				  {
					"start": "04/01/2021",
					"end": "05/30/2021",
					"label": "Apr-May '21"
				  },
				  {
					"start": "06/01/2021",
					"end": "07/30/2021",
					"label": "Jun-Jul '21"
				  },
				  {
					"start": "08/01/2021",
					"end": "09/30/2021",
					"label": "Aug-Sep '21"
				  },
				  {
					"start": "09/01/2021",
					"end": "09/30/2021",
					"label": "Oct '21"
				  },
				  {
					"start": "10/01/2021",
					"end": "10/30/2021",
					"label": "Nov '21"
				  },
				  {
					"start": "08/01/2021",
					"end": "08/30/2021",
					"label": "Aug '21"
				  }
				]
			  }],
			  "processes": {
				"fontsize": "12",
				"isbold": "1",
				"align": "left",
				"process": [{
					"label": "1. Product selection - *"
				  },
				  {
					"label": "2. Development of mfg process -R&D"
				  },
				  {
					"label": "3. Development of analytical methods- R&D"
				  },
				  {
					"label": "4. Pivotal bio batch -R&D"
				  },
				  {
					"label": "5. Tech transfer to plant -R&D/Tech Transfer"
				  },
				  {
					"label": "6. Stability data generation-R&D/Tech Transfer"
				  },
				  {
					"label": "7. Compilation of product development report-R&D"
				  },
				  {
					"label": "8. FDA approval *"
				  }
				]
			  },
			  "tasks": {
				"task": [{
					"id": "1",
					"start": "01/01/2021",
					"end": "01/10/2021"
				  },
				  {
					"id": "2",
					"start": "02/01/2021",
					"end": "02/19/2021"
				  },
				  {
					"id": "3",
					"start": "03/01/2021",
					"end": "03/16/2021"
				  },
				  {
					"id": "4",
					"start": "04/01/2021",
					"end": "04/16/2021"
				  },
				  {
					"id": "5",
					"start": "05/01/2021",
					"end": "05/17/2021"
				  },
				  {
					"id": "6",
					"start": "06/01/2021",
					"end": "06/18/2021"
				  },
				  {
					"id": "7",
					"start": "07/01/2021",
					"end": "07/24/2021"
				  },
				  {
					"id": "8",
					"start": "08/01/2021",
					"end": "08/19/2021"
				  },
				  {
					"id": "9",
					"start": "09/01/2021",
					"end": "09/24/2021"
				  },
				  {
					"id": "10",
					"start": "10/01/2021",
					"end": "10/27/2021"
				  }
				]
			  },
			  //Adding milestones with task id 1 and 8
			  "milestones": {
				"milestone": [{
					"date": "1/21/2021",
					"taskid": "1",
					"color": "#f8bd19",
					"shape": "star",
					"tooltext": "Product Selection Complete"
				  },
				  {
					"date": "08/21/2021",
					"taskid": "8",
					"color": "#f8bd19",
					"shape": "star",
					"tooltext": "Successful Completion of FDA Approval"
				  }
				]
			  }


			};
			
			var root = this.shadowRoot;
			var container = root.querySelector('#chart-container-fgantt');

			FusionCharts.ready(function() {				
			  var myChart = new FusionCharts({
				type: "gantt",
				renderAt: container,
				width: "100%",
				height: "100%",
				dataFormat: "json",
				dataSource
			  }).render();
			});
        }
        loadScript(src, shadowRoot) {
            return new Promise(function(resolve, reject) {
                let script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log("Load: " + src);
                    resolve(script);
                };
                script.onerror = () => reject(new Error(`Script load error for ${src}`));
                shadowRoot.appendChild(script);
            });
        }        
    }
    customElements.define("com-gmail-cse-ari007-fusiongantt", FGANTT);
})();